<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KPIダッシュボード</title>

<style>

body{
font-family:-apple-system,BlinkMacSystemFont;
background:#f2f4f7;
margin:0;
padding:15px;
}

.card{
background:white;
padding:15px;
margin-bottom:15px;
border-radius:10px;
box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

h2{
margin-top:0;
}

input,select,button{
width:100%;
padding:10px;
margin-top:5px;
margin-bottom:10px;
font-size:16px;
box-sizing:border-box;
}

button{
background:black;
color:white;
border:none;
border-radius:8px;
}

.checkbox{
display:flex;
align-items:center;
gap:10px;
margin-bottom:8px;
}

.checkbox input{
width:auto;
}

.green{
color:green;
font-weight:bold;
}

.red{
color:red;
font-weight:bold;
}

.history{
border-top:1px solid #ddd;
padding:8px 0;
font-size:14px;
}

.smallBtn{
background:#666;
margin-top:5px;
padding:5px;
font-size:14px;
}

.staffBox{
border-top:1px solid #ddd;
padding-top:5px;
margin-top:5px;
}

</style>
</head>

<body>

<div class="card">

<label>店舗</label>
<select id="shop" onchange="load()">
<option value="足立店">足立店</option>
<option value="江戸川店">江戸川店</option>
</select>

<label>担当者（フルネーム）</label>
<input id="staff">

<label>生保期間</label>
<select id="months">
<option value="0">未加入</option>
<option value="1">1ヶ月</option>
<option value="3">3ヶ月</option>
<option value="6">6ヶ月</option>
<option value="12">12ヶ月</option>
<option value="24">24ヶ月</option>
<option value="36">36ヶ月</option>
<option value="60">60ヶ月</option>
<option value="100">100ヶ月</option>
</select>

<label class="checkbox">
<input type="checkbox" id="medical">
<span>医保加入</span>
</label>

<label class="checkbox">
<input type="checkbox" id="premium">
<span>プレミアム加入</span>
</label>

<label class="checkbox">
<input type="checkbox" id="loan">
<span>ローン利用</span>
</label>

<label class="checkbox">
<input type="checkbox" id="hospital">
<span>病院予約</span>
</label>

<label>付帯金額（円）</label>
<input id="futai" type="number">

<button onclick="save()">契約追加 / 更新</button>

</div>


<div class="card">
<h2>店舗KPI</h2>
<div id="kpi"></div>
</div>


<div class="card">
<h2>担当者KPI</h2>
<div id="staffKpi"></div>
</div>


<div class="card">
<h2>履歴</h2>
<div id="history"></div>
</div>


<script>

const goals={
足立店:27,
江戸川店:16
};

let data=[];
let editIndex=-1;

function key(){
return "kpi_"+shop.value;
}

function rate(m){
return {
0:0,1:10,3:15,6:20,12:25,24:30,36:35,60:40,100:50
}[m];
}

function load(){
data=JSON.parse(localStorage.getItem(key()))||[];
update();
}

function save(){

const obj={
date:new Date().toLocaleString(),
staff:staff.value||"未入力",
months:Number(months.value),
rate:rate(Number(months.value)),
medical:medical.checked,
premium:premium.checked,
loan:loan.checked,
hospital:hospital.checked,
futai:Number(futai.value)||0
};

if(editIndex==-1)
data.push(obj);
else{
data[editIndex]=obj;
editIndex=-1;
}

localStorage.setItem(key(),JSON.stringify(data));

clear();
update();

}

function edit(i){

const d=data[i];

staff.value=d.staff;
months.value=d.months;
medical.checked=d.medical;
premium.checked=d.premium;
loan.checked=d.loan;
hospital.checked=d.hospital;
futai.value=d.futai;

editIndex=i;

}

function del(i){

data.splice(i,1);

localStorage.setItem(key(),JSON.stringify(data));

update();

}

function clear(){

staff.value="";
months.value=0;
medical.checked=false;
premium.checked=false;
loan.checked=false;
hospital.checked=false;
futai.value="";

}

function percent(val,goal){
return `<span class="${val>=goal?"green":"red"}">${val.toFixed(1)}%</span>`;
}

function update(){

const goal=goals[shop.value];
const count=data.length;

const seihos=data.filter(x=>x.months>0).length;
const seihorate=count?seihos/count*100:0;
const seihomoney=count?data.reduce((a,b)=>a+b.rate,0)/count:0;
const medicalrate=count?data.filter(x=>x.medical).length/count*100:0;
const loanrate=count?data.filter(x=>x.loan).length/count*100:0;
const premiumrate=count?data.filter(x=>x.premium).length/count*100:0;
const hospitalrate=count?data.filter(x=>x.hospital).length/count*100:0;
const futaiavg=count?data.reduce((a,b)=>a+b.futai,0)/count:0;

kpi.innerHTML=`
販売進捗：${count}/${goal}（残り${goal-count}）<br><br>
生保加入率：${percent(seihorate,90)}<br>
生保金額率：${percent(seihomoney,30)}<br>
医保加入率：${percent(medicalrate,90)}<br>
ローン率：${percent(loanrate,25)}<br>
プレミアム率：${percent(premiumrate,100)}<br>
病院予約率：${percent(hospitalrate,100)}<br>
付帯平均：<span class="${futaiavg>=30000?"green":"red"}">${Math.round(futaiavg)}円</span>
`;

let staffMap={};

data.forEach(d=>{
if(!staffMap[d.staff]) staffMap[d.staff]=[];
staffMap[d.staff].push(d);
});

staffKpi.innerHTML="";

for(let name in staffMap){

let list=staffMap[name];
let c=list.length;
let s=list.filter(x=>x.months>0).length;
let r=c?s/c*100:0;

staffKpi.innerHTML+=`
<div class="staffBox">
<b>${name}</b><br>
販売：${c}<br>
生保加入率：${r.toFixed(1)}%
</div>
`;
}

history.innerHTML="";

data.slice().reverse().forEach((d,i)=>{

let real=data.length-1-i;

history.innerHTML+=`
<div class="history">
${d.date}<br>
${d.staff}<br>
生保:${d.months}ヶ月　
医保:${d.medical?"〇":"×"}　
プレミアム:${d.premium?"〇":"×"}　
ローン:${d.loan?"〇":"×"}　
病院:${d.hospital?"〇":"×"}<br>
付帯:${d.futai}円<br>
<button class="smallBtn" onclick="edit(${real})">編集</button>
<button class="smallBtn" onclick="del(${real})">削除</button>
</div>
`;
});

}

load();

</script>

</body>
</html>
