<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>KPIダッシュボード</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>

body{
font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
margin:0;
padding:15px;
background:#f2f4f7;
}

.card{
background:white;
padding:15px;
margin-bottom:15px;
border-radius:10px;
}

input,select{
width:100%;
padding:12px;
margin:5px 0 10px 0;
font-size:16px;
}

button{
width:100%;
padding:14px;
background:black;
color:white;
border:none;
border-radius:8px;
font-size:16px;
margin-top:5px;
}

.history{
border-bottom:1px solid #eee;
padding:10px 0;
font-size:14px;
}

.small-btn{
width:auto;
padding:6px 10px;
font-size:14px;
margin-right:5px;
}

.safe{color:green;font-weight:bold;}
.danger{color:red;font-weight:bold;}

</style>

</head>

<body>

<h2>KPIダッシュボード</h2>

<div class="card">

<label>店舗</label>

<select id="storeSelect" onchange="loadData()">
<option value="足立店">足立店</option>
<option value="江戸川店">江戸川店</option>
</select>

<label>担当者（フルネーム）</label>
<input type="text" id="staffInput">

<label>生保期間</label>

<select id="insurance">
<option value="0">未加入</option>
<option value="1">1ヶ月</option>
<option value="3">3ヶ月</option>
<option value="6">6ヶ月</option>
<option value="12">12ヶ月</option>
<option value="24">24ヶ月</option>
<option value="36">36ヶ月</option>
<option value="60">60ヶ月</option>
<option value="100">100ヶ月</option>
</select>

<label><input type="checkbox" id="medical"> 医保加入</label>
<label><input type="checkbox" id="premium"> プレミアム加入</label>
<label><input type="checkbox" id="loan"> ローン</label>
<label><input type="checkbox" id="hospital"> 病院予約</label>

<label>付帯金額（円）</label>
<input type="number" id="futai">

<button id="mainButton" onclick="addOrUpdate()">契約追加</button>

</div>


<div class="card">
<h3>店舗KPI</h3>
<div id="storeStatus"></div>
</div>


<div class="card">
<h3>履歴</h3>
<div id="history"></div>
</div>


<script>

const TARGET={
足立店:27,
江戸川店:16
};

const RATE_MAP={
0:0,1:10,3:15,6:20,12:25,24:30,36:35,60:40,100:50
};

let contracts=[];
let editIndex=-1;


// 保存キー
function key(){
return "kpi_"+storeSelect.value;
}


// 保存
function save(){
localStorage.setItem(key(),JSON.stringify(contracts));
}


// 読込
function loadData(){

contracts=
JSON.parse(localStorage.getItem(key())||"[]");

update();

}


// 追加または更新
function addOrUpdate(){

const staff=staffInput.value;

if(!staff){
alert("担当者名を入力してください");
return;
}

const months=Number(insurance.value);

const data={

staff,
months,
rate:RATE_MAP[months],

medical:medical.checked,
premium:premium.checked,
loan:loan.checked,
hospital:hospital.checked,

futai:Number(futai.value)||0,

date:new Date().toLocaleString()

};


// 編集
if(editIndex>=0){

contracts[editIndex]=data;

editIndex=-1;

mainButton.textContent="契約追加";

}
else{

contracts.push(data);

}


save();

clearForm();

update();

}


// 編集開始
function editContract(index){

const c=contracts[index];

staffInput.value=c.staff;
insurance.value=c.months;
medical.checked=c.medical;
premium.checked=c.premium;
loan.checked=c.loan;
hospital.checked=c.hospital;
futai.value=c.futai;

editIndex=index;

mainButton.textContent="更新する";

}


// 削除
function deleteContract(index){

if(!confirm("削除しますか？")) return;

contracts.splice(index,1);

save();

update();

}


// フォームクリア
function clearForm(){

staffInput.value="";
insurance.value="0";
medical.checked=false;
premium.checked=false;
loan.checked=false;
hospital.checked=false;
futai.value="";

}


// 更新
function update(){

const target=TARGET[storeSelect.value];

const count=contracts.length;

const remain=target-count;

const join=contracts.filter(c=>c.rate>0).length;

const joinRate=count?join/count*100:0;


storeStatus.innerHTML=`

販売進捗：${count}/${target}（残り${remain}）

<br><br>

生保加入率：

<span class="${joinRate>=90?'safe':'danger'}">
${joinRate.toFixed(1)}%
</span>

`;


// 履歴表示

history.innerHTML="";

contracts.slice().reverse().forEach((c,i)=>{

const index=contracts.length-1-i;

history.innerHTML+=`

<div class="history">

${c.date}<br>

担当者：${c.staff}<br>

生保：${c.months}ヶ月（${c.rate}%）<br>

医保：${c.medical?"〇":"×"}　
プレミアム：${c.premium?"〇":"×"}　
ローン：${c.loan?"〇":"×"}　
病院予約：${c.hospital?"〇":"×"}<br>

付帯：${c.futai.toLocaleString()}円<br>

<button class="small-btn" onclick="editContract(${index})">
編集
</button>

<button class="small-btn" onclick="deleteContract(${index})">
削除
</button>

</div>

`;

});

}


loadData();

</script>

</body>
</html>
