<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KPIダッシュボード</title>

<style>
body{
font-family:sans-serif;
background:#f2f2f2;
margin:0;
padding:10px;
}

.card{
background:white;
padding:15px;
margin-bottom:15px;
border-radius:10px;
}

button{
background:black;
color:white;
padding:12px;
border:none;
border-radius:8px;
width:100%;
font-size:16px;
}

.historyItem{
border-bottom:1px solid #ddd;
padding:10px 0;
}

.editBtn{
background:#007bff;
margin-top:5px;
}

.deleteBtn{
background:#dc3545;
margin-top:5px;
}

.good{color:green;}
.bad{color:red;}
</style>

</head>
<body>

<div class="card">

担当者<br>
<input id="staff"><br><br>

生保期間<br>
<select id="seibo">
<option value="0">未加入</option>
<option value="10">1ヶ月</option>
<option value="15">3ヶ月</option>
<option value="20">6ヶ月</option>
<option value="25">12ヶ月</option>
<option value="30">24ヶ月</option>
<option value="35">36ヶ月</option>
<option value="40">60ヶ月</option>
<option value="50">100ヶ月</option>
</select><br><br>

<label><input type="checkbox" id="medical"> 医保加入</label><br>
<label><input type="checkbox" id="premium"> プレミアム加入</label><br>
<label><input type="checkbox" id="loan"> ローン利用</label><br>
<label><input type="checkbox" id="hospital"> 病院予約</label><br><br>

付帯金額<br>
<input id="amount"><br><br>

<button onclick="add()">契約追加 / 更新</button>

</div>


<div class="card">
<h3>店舗KPI</h3>
<div id="shopKPI"></div>
</div>

<div class="card">
<h3>担当者KPI</h3>
<div id="staffKPI"></div>
</div>

<div class="card">
<h3>履歴</h3>
<div id="history"></div>
</div>


<script>

let data=JSON.parse(localStorage.getItem("kpiData")||"[]");
let editIndex=null;

const TARGET=27;

function save(){
localStorage.setItem("kpiData",JSON.stringify(data));
}

function add(){

const item={
staff:staff.value||"未入力",
seibo:Number(seibo.value),
medical:medical.checked,
premium:premium.checked,
loan:loan.checked,
hospital: hospital.checked,
amount:Number(amount.value)||0
};

if(editIndex!==null){
data[editIndex]=item;
editIndex=null;
}else{
data.push(item);
}

save();
renderAll();
clearForm();

}

function clearForm(){

staff.value="";
seibo.value=0;
medical.checked=false;
premium.checked=false;
loan.checked=false;
hospital.checked=false;
amount.value="";

}

function renderAll(){

renderShop();
renderStaff();
renderHistory();

}

function renderShop(){

let total=data.length;
let remain=TARGET-total;

let seiboCount=data.filter(d=>d.seibo>0).length;
let seiboRate=(seiboCount/total*100)||0;

let targetRate=90;
let neededCount=Math.ceil((targetRate/100)*TARGET);
let remainNeed=neededCount-seiboCount;
let remainRate=remain>0?(remainNeed/remain*100):0;

let html=`
販売進捗： ${total}/${TARGET}（残り${remain}）<br><br>

生保加入率：
<span class="${seiboRate>=targetRate?'good':'bad'}">
${seiboRate.toFixed(1)}%
</span>
${remain>0?`　残り必要平均 ${remainRate.toFixed(1)}%`:"　達成"}
`;

shopKPI.innerHTML=html;

}

function renderStaff(){

let map={};

data.forEach(d=>{

if(!map[d.staff]){

map[d.staff]={
count:0,
seiboTotal:0,
medical:0,
premium:0,
loan:0,
hospital:0,
amount:0
};

}

let s=map[d.staff];

s.count++;

if(d.seibo>0)s.seiboTotal+=d.seibo;
if(d.medical)s.medical++;
if(d.premium)s.premium++;
if(d.loan)s.loan++;
if(d.hospital)s.hospital++;

s.amount+=d.amount;

});

let html="";

for(let name in map){

let s=map[name];

html+=`
<div>

<b>${name}</b><br>

販売：${s.count}<br>

生保加入率：${(s.seiboTotal/s.count).toFixed(1)}%<br>

医保加入率：${(s.medical/s.count*100).toFixed(1)}%<br>

ローン率：${(s.loan/s.count*100).toFixed(1)}%<br>

プレミアム率：${(s.premium/s.count*100).toFixed(1)}%<br>

病院予約率：${(s.hospital/s.count*100).toFixed(1)}%<br>

付帯平均：${Math.round(s.amount/s.count)}円

</div>
<hr>
`;

}

staffKPI.innerHTML=html;

}

function renderHistory(){

let html="";

data.forEach((d,i)=>{

html+=`

<div class="historyItem">

<b>${d.staff}</b><br>

生保：${d.seibo}%<br>

医保：${d.medical?"〇":"×"}<br>

プレミアム：${d.premium?"〇":"×"}<br>

ローン：${d.loan?"〇":"×"}<br>

病院：${d.hospital?"〇":"×"}<br>

付帯：${d.amount}円<br>

<button class="editBtn" onclick="edit(${i})">編集</button>

<button class="deleteBtn" onclick="del(${i})">削除</button>

</div>

`;

});

history.innerHTML=html;

}

function edit(i){

let d=data[i];

staff.value=d.staff;
seibo.value=d.seibo;
medical.checked=d.medical;
premium.checked=d.premium;
loan.checked=d.loan;
hospital.checked=d.hospital;
amount.value=d.amount;

editIndex=i;

window.scrollTo(0,0);

}

function del(i){

if(!confirm("削除しますか？"))return;

data.splice(i,1);

save();
renderAll();

}

renderAll();

</script>

</body>
</html>
