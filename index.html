<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>KPIダッシュボード</title>

<style>

body{
font-family:-apple-system,BlinkMacSystemFont;
background:#f2f4f7;
margin:0;
padding:15px;
}

.card{
background:white;
padding:15px;
margin-bottom:15px;
border-radius:10px;
box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

h2{
margin-top:0;
}

input,select,button{
width:100%;
padding:10px;
margin-top:5px;
margin-bottom:10px;
font-size:16px;
box-sizing:border-box;
}

button{
background:black;
color:white;
border:none;
border-radius:8px;
}

.checkbox{
display:flex;
align-items:center;
gap:10px;
margin-bottom:8px;
}

.checkbox input{
width:auto;
}

.green{color:green;font-weight:bold;}
.red{color:red;font-weight:bold;}

.history{
border-top:1px solid #ddd;
padding:8px 0;
}

.smallBtn{
background:#666;
padding:5px;
margin-top:5px;
font-size:14px;
}

.staffBox{
border-top:1px solid #ddd;
padding-top:5px;
margin-top:5px;
}

.need{
font-size:14px;
color:#555;
margin-left:10px;
}

</style>
</head>

<body>

<div class="card">

<label>店舗</label>
<select id="shop" onchange="load()">
<option value="足立店">足立店</option>
<option value="江戸川店">江戸川店</option>
</select>

<label>担当者（フルネーム）</label>
<input id="staff">

<label>生保期間</label>
<select id="months">
<option value="0">未加入</option>
<option value="1">1ヶ月</option>
<option value="3">3ヶ月</option>
<option value="6">6ヶ月</option>
<option value="12">12ヶ月</option>
<option value="24">24ヶ月</option>
<option value="36">36ヶ月</option>
<option value="60">60ヶ月</option>
<option value="100">100ヶ月</option>
</select>

<label class="checkbox">
<input type="checkbox" id="medical">
<span>医保加入</span>
</label>

<label class="checkbox">
<input type="checkbox" id="premium">
<span>プレミアム加入</span>
</label>

<label class="checkbox">
<input type="checkbox" id="loan">
<span>ローン利用</span>
</label>

<label class="checkbox">
<input type="checkbox" id="hospital">
<span>病院予約</span>
</label>

<label>付帯金額（円）</label>
<input id="futai" type="number">

<button onclick="save()">契約追加 / 更新</button>

</div>



<div class="card">
<h2>店舗KPI</h2>
<div id="kpi"></div>
</div>



<div class="card">
<h2>担当者KPI</h2>
<div id="staffKpi"></div>
</div>



<div class="card">
<h2>履歴</h2>
<div id="history"></div>
</div>



<script>

const goals={
足立店:27,
江戸川店:16
};

const targets={
seihorate:90,
seihomoney:30,
medical:90,
loan:25,
premium:100,
hospital:100,
futai:30000
};

let data=[];
let editIndex=-1;

function key(){
return "kpi_"+shop.value;
}

function rate(m){

return{
0:0,1:10,3:15,6:20,12:25,24:30,36:35,60:40,100:50
}[m];

}


function load(){

data=JSON.parse(localStorage.getItem(key()))||[];

update();

}


function save(){

const obj={

date:new Date().toLocaleString(),

staff:staff.value||"未入力",

months:Number(months.value),

rate:rate(Number(months.value)),

medical:medical.checked,

premium:premium.checked,

loan:loan.checked,

hospital:hospital.checked,

futai:Number(futai.value)||0

};

if(editIndex==-1)
data.push(obj);
else{
data[editIndex]=obj;
editIndex=-1;
}

localStorage.setItem(key(),JSON.stringify(data));

clear();

update();

}


function edit(i){

const d=data[i];

staff.value=d.staff;
months.value=d.months;
medical.checked=d.medical;
premium.checked=d.premium;
loan.checked=d.loan;
hospital.checked=d.hospital;
futai.value=d.futai;

editIndex=i;

window.scrollTo({top:0,behavior:"smooth"});

alert("修正して『契約追加 / 更新』を押してください");

}


function del(i){

data.splice(i,1);

localStorage.setItem(key(),JSON.stringify(data));

update();

}


function clear(){

staff.value="";
months.value=0;
medical.checked=false;
premium.checked=false;
loan.checked=false;
hospital.checked=false;
futai.value="";

}



function color(v,t){

return `<span class="${v>=t?"green":"red"}">${v.toFixed(1)}%</span>`;

}



function update(){

const goal=goals[shop.value];

const count=data.length;

const remain=goal-count;

const seihos=data.filter(x=>x.months>0).length;
const seihorate=count?seihos/count*100:0;

const seihomoney=count?data.reduce((a,b)=>a+b.rate,0)/count:0;

const medical=count?data.filter(x=>x.medical).length/count*100:0;

const loan=count?data.filter(x=>x.loan).length/count*100:0;

const premium=count?data.filter(x=>x.premium).length/count*100:0;

const hospital=count?data.filter(x=>x.hospital).length/count*100:0;

const futai=count?data.reduce((a,b)=>a+b.futai,0)/count:0;



function needRate(current,total,target){

if(remain<=0)return "達成";

const needed=(target*goal-current*total)/remain;

return needed>0?`残り必要平均 ${needed.toFixed(1)}%`:"達成";

}

function needYen(current,total,target){

if(remain<=0)return "達成";

const needed=(target*goal-current*total)/remain;

return needed>0?`残り必要平均 ${Math.round(needed)}円`:"達成";

}



kpi.innerHTML=`

販売進捗：${count}/${goal}（残り${remain}）<br><br>

生保加入率：${color(seihorate,targets.seihorate)}
<span class="need">${needRate(seihos,count,targets.seihorate)}</span><br>

生保金額率：${color(seihomoney,targets.seihomoney)}
<span class="need">${needRate(seihomoney,count,targets.seihomoney)}</span><br>

医保加入率：${color(medical,targets.medical)}
<span class="need">${needRate(medical,count,targets.medical)}</span><br>

ローン率：${color(loan,targets.loan)}
<span class="need">${needRate(loan,count,targets.loan)}</span><br>

プレミアム率：${color(premium,targets.premium)}
<span class="need">${needRate(premium,count,targets.premium)}</span><br>

病院予約率：${color(hospital,targets.hospital)}
<span class="need">${needRate(hospital,count,targets.hospital)}</span><br>

付帯平均：
<span class="${futai>=targets.futai?"green":"red"}">${Math.round(futai)}円</span>
<span class="need">${needYen(futai,count,targets.futai)}</span>

`;



/* 担当者KPI */

let map={};

data.forEach(d=>{
if(!map[d.staff])map[d.staff]=[];
map[d.staff].push(d);
});

staffKpi.innerHTML="";

for(let name in map){

let list=map[name];

let c=list.length;

let sr=list.filter(x=>x.months>0).length/c*100;

let sm=list.reduce((a,b)=>a+b.rate,0)/c;

let md=list.filter(x=>x.medical).length/c*100;

let ln=list.filter(x=>x.loan).length/c*100;

let pr=list.filter(x=>x.premium).length/c*100;

let hs=list.filter(x=>x.hospital).length/c*100;

let ft=list.reduce((a,b)=>a+b.futai,0)/c;

staffKpi.innerHTML+=`

<div class="staffBox">

<b>${name}</b><br>

販売：${c}<br>

生保加入率：${sr.toFixed(1)}%<br>

生保金額率：${sm.toFixed(1)}%<br>

医保加入率：${md.toFixed(1)}%<br>

ローン率：${ln.toFixed(1)}%<br>

プレミアム率：${pr.toFixed(1)}%<br>

病院予約率：${hs.toFixed(1)}%<br>

付帯平均：${Math.round(ft)}円

</div>

`;

}



/* 履歴 */

history.innerHTML="";

data.slice().reverse().forEach((d,i)=>{

let real=data.length-1-i;

history.innerHTML+=`

<div class="history">

${d.date}<br>

${d.staff}<br>

生保:${d.months}ヶ月　

医保:${d.medical?"〇":"×"}　

プレミアム:${d.premium?"〇":"×"}　

ローン:${d.loan?"〇":"×"}　

病院:${d.hospital?"〇":"×"}<br>

付帯:${d.futai}円<br>

<button class="smallBtn" onclick="edit(${real})">編集</button>

<button class="smallBtn" onclick="del(${real})">削除</button>

</div>

`;

});

}


load();

</script>

</body>
</html>
